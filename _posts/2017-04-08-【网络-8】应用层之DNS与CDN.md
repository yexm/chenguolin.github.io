---
layout:  post    # 使用的布局（不需要改）
catalog: true   # 是否归档
author: 陈国林 # 作者
tags:         #标签
    - 网络
---

# 一. DNS
`DNS`中文名称`域名解析系统`，计算机网络中大部分的通信采用的TCP/IP，因此计算机需要智能识别IP地址。由于IP地址不便于记忆，因此发明了域名解析系统，用于把一个域名解析为具体的IP地址。

![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/dns-root.png?raw=true)

1. 根域：`.`  (返回顶级域 DNS 服务器的 IP 地址，全球有13个根域名服务)
2. 顶级域：`.com`   （返回权威 DNS 服务器的 IP 地址）
3. 二级域：`baidu.com` （权威 DNS 服务器，返回相应主机的 IP 地址）
4. 子域名：`www.baidu.com`

DNS解析过程如下，例如我们访问 google.com 的域名解析过程如下，客户端->本地DNS服务器是`递归查询`，本地DNS服务器->各级权威DNS服务器是`迭代查询`。所以，我们一般也称本地DNS服务器为递归服务器
![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/dns-trace.png?raw=true)

```
1. 访问 www.googole.com
2. 先检查主机 hosts 文件中是否存在 www.googole.com 对应的解析记录，有直接返回
3. 继续检查主机 DNS 缓存中是否存在 www.googole.com 对应的解析记录，有直接返回  (https://www.linuxjournal.com/content/localhost-dns-cache)
4. 向本地 DNS 服务器 （ISP DNS）发起 DNS 查询请求
5. 路由器接收到 DNS 查询请求后，检查路由器 DNS 缓存，有直接返回
6. 路由器向本地 DNS 服务器 （ISP DNS）发起 DNS 查询请求
7. 本地 DNS 服务器接收到 DNS 查询请求后，发现自己不是权威 DNS ，且无对应的缓存数据，于是开始进行 DNS 迭代查询
8. 本地 DNS 服务器将请求发送给 根域名服务器，根域名服务器 接收到请求后，将 顶级域名服务器 (.com) IP 发送给 本地 DNS 服务器
9. 本地 DNS 服务器将请求发送给 顶级域名服务器，顶级域名服务器 接收到请求后，将 二级域名服务器 (google.com) IP 发送给 本地 DNS 服务器
10. 本地 DNS 服务器将请求发送给 二级域名服务器，二级域名服务器 接收到请求后，发现自己是 权威 DNS 服务器，于是将 www.google.com 解析的 IP 发送给 本地 DNS 服务器
11. 本地 DNS 服务器 接收到解析结果后，将 IP 逐层返回传递下去，最终直至 192.168.110.252

14.其他域名服务器 接收到解析结果后，将 120.132.92.21 逐层返回传递下去，最终直至 192.168.110.252
15.192.168.110.252 接收到 www.jianshu.com 解析结果 120.132.92.21 ，根据 IP 与 www.jianshu.com 建立 TCP 连接，然后发起 HTTP 请求主页内容
```

DNS解析有2种方式
1. `递归查询`: 递归查询的DNS会替发起请求的用户客户端完成一系列的DNS查询，直到获取了最终结果后，返回给查询客户端。大多数Client向Local DNS服务器请求解析采用这种方式。
2. `迭代查询`: 迭代查询各级DNS都把自己知道的信息反馈给客户端，所有的查询过程都由发起请求的客户端自己完成。大多数Local DNS服务器向其他DNS服务器请求解析采用这种方式。

DNS 服务器根据作用可以分为以下4个类型
1. `缓存域名服务器`: 通过向其他域名服务器查询获得域名->IP地址记录，将域名查询结果缓存到本地，提高重复查询时的速度，本地不设置DNS信息
2. `主域名服务器`: 特定DNS区域的官方服务器，具有唯一性，负责维护该区域内所有域名->IP地址的映射记录
3. `从域名服务器`: 其维护的域名->IP地址记录 来源于主域名服务器
4. `转发服务器`: 转发服务器接受查询请求，但并不直接提供DNS解析，而是将所有查询请求发送至另外的DNS服务器，查询结果返回后保存至缓存。

DNS 还可以做 `全局负载均衡`: 为了保证我们的应用高可用，往往会部署在多个机房，每个地方都会有自己的 IP 地址。当用户访问某个域名的时候，这个 IP 地址可以轮询访问多个数据中心。如果一个数据中心因为某种原因挂了，只要在 DNS 服务器里面，将这个数据中心对应的 IP 地址删除，就可以实现一定的高可用。对于简单的应用来说，通过把域名解析为一个或多个IP地址，通过Round-Robin算法就可以实现简单的负载均衡。

通过上面的示例过程我们知道，域名解析过程涉及到好几个环节，因此存在不少问题。

1. `缓存问题`: 客户端发起域名解析的整个请求过程中涉及到好几个环节，为了保证请求的时效性，会对域名结果做缓存。例如 本地DNS服务器 不会每次DNS解析都去请求根域名服务器，而是会在服务器内部做缓存。引入缓存，必然会带来不一致问题，也就是说可能会导致域名解析结果不对。
2. `缓存TTL`: 本地 DNS 服务器是由不同地区、不同运营商独立部署的。对域名解析缓存的处理上，实现策略也有区别，有的会忽略域名解析结果的 TTL 时间限制，在权威 DNS 服务器解析变更的时候，导致解析结果在全网生效的周期非常漫长。
3. `解析延迟`: 域名解析过程需要递归遍历多个 DNS 服务器，才能获得最终的解析结果，这会带来一定的时延，甚至会解析超时。

# 二. HTTPDNS
`HTTPNDS` 其实就是不走传统的 DNS 解析，而是自己搭建基于 HTTP 协议的 DNS 服务器集群，分布在多个地点和多个运营商。当客户端需要 DNS 解析的时候，直接通过 HTTP 协议进行请求这个服务器集群，得到就近的地址。

默认的域名解析都是走 DNS 的，因而使用 HTTPDNS 需要绕过默认的 DNS 路径，就不能使用默认的客户端。使用 HTTPDNS 的，往往是手机APP，需要在APP嵌入支持 HTTPDNS 的客户端 SDK。由于客户端嵌入了 SDK，就可以知道手机是哪个国家、哪个运营商、哪个省，甚至哪个市，HTTPDNS 服务端可以根据这些信息，选择最佳的服务节点返回。

![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/httpdns.jpg?raw=true)

# 三. CDN
`CDN` 中文名称为内容分发网络，用来解决不同地域的用户访问网站速度慢问题，通过缓存各种静态文件（css／html／图片等）达到速度优化的目的，核心是`智能DNS调度`。

![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/cdn-trace.png?raw=true)

1. 离用户最近的节点称为`边缘节点`
2. A记录指域名解析得到的一个IP地址 (IPV4)
3. CNAME指域名解析到另一个域名

整个CDN系统最核心的部分是 智能DNS调度 英文名为GSLB，目前有以下几个实现方式

1. 基于DNS的GSLB: 通过LDNS的所属区域，利用DNS解析给用户返回该区域的边缘节点IP列表，但是存在LDNS不对导致返回的边缘节点IP不是离用户最近。这种方式无法获取用户IP地址，只能获取到LDNS的IP地址。
2. 基于HTTP 302的GSLB: 用户访问某个服务的时候根据其IP地址，返回一个302的头信息，引导用户到最近的边缘节点，这种方式会多一次HTTP请求。302调度一般都是先通过DNS获取到一个边缘节点IP，再进行一次302，流程比较长。

