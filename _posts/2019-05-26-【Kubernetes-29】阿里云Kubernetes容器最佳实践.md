---
layout:  post  # 使用的布局（不需要改）
catalog: true  # 是否归档
author: 陈国林 # 作者
tags:          #标签
    - Kubernetes
---

本文参考自 [阿里云容器产品实践.pdf](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/pdf/%E9%98%BF%E9%87%8C%E4%BA%91%E5%AE%B9%E5%99%A8%E4%BA%A7%E5%93%81%E5%AE%9E%E8%B7%B5.pdf)

# 一. 容器平台构建
1. **集群容量规划**
   服务总实例 * 实例规格 * 冗余，例如有18个微服务每个服务2个实例，每个实例用2c/4g，预留10%冗余  
   总资源:18 X 2 X 2c/4g X 110% = 72c/144g X 110% = 80c/160g   
   注意:需要估算daemonset, job等类型的资源

2. **集群网络规划**  
   明确ECS所在的VPC的IP段，是否与其它服务关联(RDS)，是否有专线与私有云IDC互联，路由是否已经打通等   
   明确POD的IP段，是否需要与非K8S集群的ECS互联，例如其它ECS上部署的服务 
   明确Service的IP段，此IP为虚IP不可与其它ECS的IP段冲突  
   需要考虑跨可用区的网络设计

3. **集群ECS选型**  
   Master机型的建议选择:100节点以内8c/32g、100~200节点16c/64g，尽量预留多点资源
   Woker机型的选择:根据总体容量以及可以容忍的ECS掉线率来计算使用的规格，如1000c的总容量，那么容忍10%的容量掉线率，那么可以使用10台96c的神龙机器  
   Woker容量预留:确保剩余的可用容量能承担任意一台ECS掉线带来的容器漂移  
   
   `为什么Worker尽可能选高规格的机器？`
   + Woker数量相对少了，Master的负担最小，调度性能最优，减轻了运维的维护工作量和成本
   + Woker数量相对少了，Pull image的次数减少，减少带宽占用，提高容器调度效率
   + Woker数量相对少了，剩余碎片资源少，资源利用率最好（同系列规格机器，高规格机器没有增加成本，反而因为系统盘减少而相对减少成本）
   + Woker单机规格增大，驱逐的概率降低

4. **集群网络选型**  
   支持两种模型:flannel和terway，terway具备更高的性能以及支持 network policy  
   注意选择节点支持的POD的IP个数，避免IP浪费，从而影响集群能支持的节点的个数  
   支持最大节点数:POD的最大IP数/每个节点POD的IP个数(与节点支持的POD个数无关--max-pods)

5. **集群配置设置**  
   Worker配置: 需要选择挂载数据盘，该数据盘用在 /var/lib/docker 以及 /var/lib/kubelet，避免镜像多次拉取后撑爆系统盘（系统盘和数据盘）  
   确保机器都可以上网(配置SNAT)  
   磁盘的空间不要设置太小，生产一般给系统盘留`100G`，尽量使用SSD云盘

# 二. 容器平台运维

# 三. 容器平台配置管理

# 四. 容器平台日志管理

# 五. 容器平台监控管理

# 六. 容器平台安全管理

# 七. 容器平台开发管理
